{% extends 'base.html' %}
{% load static %}
{% load video_filters %}

{% block title %}{{ course.title }} - {{ block.super }}{% endblock %}

{% block content %}
<div class="max-w-7xl mx-auto px-4 py-8">
    <h1 class="text-3xl font-bold mb-6">{{ course.title }}</h1>
    <div class="mb-6">
        <a href="/" class="inline-flex items-center px-4 py-2 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-md transition-colors">
            <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path>
            </svg>
            Orqaga
        </a>
    </div>
    
    {% if show_auth_message %}
    <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-6 rounded">
        <div class="flex">
            <div class="flex-shrink-0">
                <svg class="h-5 w-5 text-yellow-600" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 20 20" fill="currentColor">
                    <path fill-rule="evenodd" d="M8.257 3.099c.765-1.36 2.722-1.36 3.486 0l5.58 9.92c.75 1.334-.213 2.98-1.742 2.98H4.42c-1.53 0-2.493-1.646-1.743-2.98l5.58-9.92zM11 13a1 1 0 11-2 0 1 1 0 012 0zm-1-8a1 1 0 00-1 1v3a1 1 0 002 0V6a1 1 0 00-1-1z" clip-rule="evenodd" />
                </svg>
            </div>
            <div class="ml-3">
                <p class="text-sm">
                    Kursni ko'rish uchun iltimos, ro'yxatdan o'ting yoki tizimga kiring.
                    <a href="{% url 'login' %}?next={% url 'course_detail' course.id %}" class="font-medium text-yellow-700 hover:text-yellow-600">Kirish</a>
                    yoki
                    <a href="{% url 'register' %}?next={% url 'course_detail' course.id %}" class="font-medium text-yellow-700 hover:text-yellow-600">Ro'yxatdan o'tish</a>
                </p>
            </div>
        </div>
    </div>
    {% endif %}
    
    {% if show_enroll_message %}
    <div class="bg-blue-50 border border-blue-200 rounded-lg p-6 mb-8 text-center">
        <h3 class="text-2xl font-bold text-gray-800 mb-4">Ushbu kursni sotib oling</h3>
        <p class="text-gray-600 mb-6">Kursga yozilish uchun quyidagi tugmani bosing va to'lov usulini tanlang</p>
        <button onclick="document.getElementById('paymentModal').classList.remove('hidden')" class="inline-flex items-center justify-center px-8 py-3 border border-transparent text-base font-medium rounded-md text-white bg-yellow-500 hover:bg-yellow-600 md:py-4 md:text-lg md:px-10 transition-colors duration-200">
            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mr-2" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 3h2l.4 2M7 13h10l4-8H5.4M7 13L5.4 5M7 13l-2.293 2.293c-.63.63-.184 1.707.707 1.707H17m0 0a2 2 0 100 4 2 2 0 000-4zm-8 2a2 2 0 11-4 0 2 2 0 014 0z" />
            </svg>
            Sotib olish
        </button>
        <p class="mt-3 text-sm text-gray-500">Xavfsiz to'lov tizimi orqali xavfsiz to'lov qilishingiz mumkin</p>
    </div>
    {% endif %}
    
    <!-- Payment Options Modal -->
    <div id="paymentModal" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 overflow-y-auto h-full w-full z-50">
        <div class="relative top-20 mx-auto p-5 border w-11/12 md:w-1/2 lg:w-1/3 shadow-lg rounded-md bg-white">
            <div class="mt-3 text-center">
                <h3 class="text-2xl font-bold text-gray-900 mb-6">To'lov usulini tanlang</h3>
                <div class="mt-2 px-7 py-3 space-y-4">
                    <a href="{% url 'payment:click_prepare' course.id %}" class="block w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center">
                        <img src="https://cdn.iconscout.com/icon/free/png-256/free-click-1868981-1583131.png" alt="Click" class="h-8 w-8 mr-2">
                        CLICK orqali to'lash
                    </a>
                    <a href="{% url 'payment:payme_prepare' course.id %}" class="block w-full bg-purple-600 hover:bg-purple-700 text-white font-bold py-4 px-4 rounded-lg transition-colors duration-200 flex items-center justify-center">
                        <img src="https://play-lh.googleusercontent.com/6uCJvx1B0tLxJBidMeRD1ebYVjUJj0N8vAOC0rXWX7y5u0X6yX7y9Q0ZQ9Z5Z5Z5Z5" alt="Payme" class="h-8 w-8 mr-2 rounded-full">
                        PAYME orqali to'lash
                    </a>
                    <button onclick="document.getElementById('paymentModal').classList.add('hidden')" class="w-full bg-gray-300 hover:bg-gray-400 text-gray-800 font-bold py-3 px-4 rounded-lg transition-colors duration-200">
                        Bekor qilish
                    </button>
                </div>
            </div>
        </div>
    </div>
    
    {% if not show_auth_message and not show_enroll_message %}
    {% for lesson in course.lessons.all %}
    <div class="bg-white rounded-lg shadow-md p-6 mb-6">
        <h2 class="text-xl font-semibold mb-3">{{ forloop.counter }}. {{ lesson.title }}</h2>
        
        {% if lesson.video_id %}
        <div class="mt-4">
            <div 
                onclick="toggleVideo({{ forloop.counter }})"
                class="group block relative w-full h-64 bg-gray-100 rounded-xl overflow-hidden hover:bg-gray-200 transition-colors cursor-pointer">
                
                <div class="absolute inset-0 flex items-center justify-center">
                    <div class="w-20 h-20 bg-blue-600 rounded-full flex items-center justify-center transform group-hover:scale-110 transition-transform">
                        <svg class="w-10 h-10 text-white ml-1" fill="currentColor" viewBox="0 0 20 20">
                            <path d="M6.3 2.84A1.5 1.5 0 004 4.11v11.78a1.5 1.5 0 002.3 1.27l9.34-5.89a1.5 1.5 0 000-2.54L6.3 2.84z"/>
                        </svg>
                    </div>
                </div>
                
                <div class="absolute bottom-4 left-4 flex space-x-2">
                    <div class="bg-black/70 text-white px-3 py-1 rounded-full text-sm">
                        Videoni ko'rish
                    </div>
                    {% if lesson.notion_url %}
                    <a href="{{ lesson.notion_url }}" target="_blank" class="bg-purple-600 hover:bg-purple-700 text-white px-3 py-1 rounded-full text-sm flex items-center transition-colors">
                        <svg class="w-4 h-4 mr-1" fill="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                            <path d="M4.459 4.208c.746.606 1.781.856 3.028.806.51-.022.953-.15 1.4-.36.45-.21.902-.48 1.41-.832.45-.306.9-.7 1.358-1.178.32-.32.64-.64 1.04-.852.51-.32 1.11-.48 1.8-.48h.13v10.86l-.01.2c-.06.61-.32 1.14-.84 1.56-.5.4-1.1.58-1.82.58-.42 0-.81-.1-1.15-.3-.34-.2-.63-.49-.88-.86l-.27-.41-1.24-1.9c-.27-.42-.6-.76-1-.99-.4-.24-.84-.36-1.33-.36-.5 0-.95.12-1.34.36-.39.23-.7.57-.94.99-.23.41-.35.88-.35 1.4 0 .51.12.98.35 1.4.24.42.55.76.94 1 .39.24.84.36 1.34.36.53 0 1.01-.12 1.45-.36.44-.24.8-.57 1.08-.99l.08-.13 1.24-1.9c.13-.19.25-.35.37-.49.12-.14.27-.25.43-.35.16-.1.34-.15.53-.15.2 0 .38.05.53.15.15.1.3.21.43.35.12.14.24.3.37.49l1.24 1.9.08.13c.28.42.64.75 1.08.99.44.24.92.36 1.45.36 1.14 0 2.08-.5 2.7-1.5.62-1 .78-2.25.47-3.7l-.07-.31V2.5c0-.28.1-.52.3-.7.2-.18.44-.27.73-.27.28 0 .53.09.71.27.18.18.27.42.27.7v10.9c0 .56-.1 1.1-.3 1.6-.2.5-.5.95-.9 1.35-.4.4-.85.7-1.35.9-.5.2-1.04.3-1.6.3-.56 0-1.1-.1-1.6-.3-.5-.2-.95-.5-1.35-.9-.4-.4-.7-.85-.9-1.35-.2-.5-.3-1.04-.3-1.6V5.6c-.19.17-.39.33-.6.48-.5.34-1 .6-1.5.78-.5.18-1.03.27-1.59.27-1.24 0-2.32-.27-3.24-.8-.92-.53-1.56-1.3-1.92-2.3-.36-1-.4-2.15-.12-3.45.03-.14.07-.28.12-.42.05-.14.1-.28.17-.42.06-.14.13-.28.21-.42.08-.14.16-.27.25-.4.09-.13.18-.26.28-.39.1-.13.2-.25.31-.37.1-.12.21-.24.32-.35.11-.11.22-.22.34-.32.12-.1.24-.2.36-.29.13-.1.26-.19.39-.28.13-.09.27-.18.41-.26.14-.08.28-.16.42-.23.14-.07.29-.14.43-.2.15-.06.3-.11.45-.16.15-.05.3-.1.46-.14.16-.04.32-.08.48-.11.16-.03.32-.06.48-.08.17-.02.33-.04.5-.05.17-.01.33-.02.5-.02.17 0 .34.01.5.02.17.01.33.03.5.05.16.02.32.05.48.08.16.03.32.07.47.11.16.04.31.09.46.14.15.05.3.1.44.17.14.06.28.13.42.21.14.08.28.16.41.25.13.09.26.18.39.28.12.1.24.19.35.3.11.1.22.21.33.32.1.11.2.23.3.35.1.12.19.25.28.39.09.14.17.27.24.41.07.14.13.29.19.43.06.14.11.29.15.44.05.15.09.3.12.46.03.16.06.32.08.48.02.16.03.33.04.5.01.17.02.33.02.5 0 .17-.01.33-.02.5-.01.17-.02.33-.04.5-.02.16-.05.32-.08.48-.03.16-.07.31-.12.46-.05.15-.1.3-.16.44-.06.14-.12.28-.19.42-.07.14-.15.28-.24.42-.09.14-.18.26-.28.38-.1.12-.2.24-.31.36-.11.12-.22.23-.34.34-.12.11-.23.22-.36.32-.12.1-.25.2-.38.3-.13.09-.26.18-.4.26-.14.08-.28.16-.43.23-.15.07-.3.14-.45.2-.15.06-.31.11-.46.16-.16.05-.31.1-.47.13-.16.04-.32.08-.49.11-.16.03-.33.06-.5.08-.17.02-.34.03-.51.04-.17.01-.34.02-.51.02-.17 0-.34-.01-.51-.02-.17-.01-.34-.03-.5-.06-.17-.02-.33-.05-.49-.09-.16-.04-.32-.08-.47-.13-.15-.05-.3-.1-.45-.16-.15-.06-.29-.13-.44-.2-.14-.07-.28-.15-.42-.23-.14-.08-.27-.17-.4-.26-.13-.09-.25-.19-.38-.29-.12-.1-.24-.21-.36-.32-.11-.11-.22-.23-.33-.35-.1-.12-.2-.25-.3-.38-.1-.13-.19-.26-.28-.4-.09-.14-.17-.28-.24-.42-.07-.14-.13-.29-.19-.43-.06-.14-.11-.29-.15-.44-.05-.15-.09-.3-.12-.46-.03-.16-.05-.32-.07-.49-.02-.17-.04-.34-.04-.51 0-.17.01-.34.03-.51.02-.17.04-.34.07-.5.03-.17.07-.33.12-.49.05-.16.1-.31.16-.46.06-.15.13-.3.21-.44.08-.14.16-.28.25-.41.09-.13.18-.26.28-.39.1-.13.2-.25.31-.37.11-.12.22-.23.34-.34.12-.11.24-.21.37-.31.13-.1.25-.19.39-.28.13-.09.27-.18.41-.26.14-.08.28-.16.43-.23.15-.07.3-.14.45-.19.15-.06.31-.11.46-.16.16-.05.31-.09.47-.13.16-.04.32-.07.49-.1.17-.03.33-.05.5-.07.17-.02.34-.03.51-.04.17-.01.34-.02.51-.02.17 0 .34.01.51.02.17.01.33.02.49.04.16.02.32.05.48.08.16.03.31.07.47.11.15.04.3.09.45.15.15.06.29.12.43.19.14.07.28.15.42.23.14.08.27.17.4.26.13.09.25.19.37.29.12.1.23.21.35.32.11.11.22.22.32.34.1.12.2.25.29.38.09.13.17.27.25.41.08.14.15.29.21.44.06.15.11.3.15.46.04.16.08.32.11.49.03.17.05.34.06.51.01.17.02.34.02.51 0 .17-.01.34-.03.51-.02.17-.04.33-.07.5-.03.16-.07.32-.12.48-.05.16-.1.31-.16.46-.06.15-.13.3-.21.44-.08.14-.16.28-.25.41-.09.13-.18.26-.28.39-.1.13-.2.25-.31.37-.11.12-.22.23-.34.34-.12.11-.24.21-.37.31-.13.1-.25.19-.39.28-.13.09-.27.18-.41.26-.14.08-.28.15-.43.22-.15.07-.3.13-.46.19-.15.06-.31.11-.47.15-.16.04-.32.08-.49.11-.16.03-.33.06-.5.08-.17.02-.34.03-.51.04-.17.01-.34.02-.51.02-.17 0-.34-.01-.51-.02-.17-.01-.34-.02-.5-.04-.17-.02-.33-.05-.49-.08-.16-.03-.32-.07-.48-.11-.15-.04-.31-.09-.46-.15-.15-.06-.3-.12-.44-.2-.14-.07-.28-.15-.42-.23-.14-.08-.27-.17-.4-.26-.13-.09-.25-.19-.37-.29-.12-.1-.23-.21-.34-.33-.11-.11-.21-.23-.31-.36-.1-.13-.19-.26-.27-.4-.08-.14-.15-.29-.22-.44-.07-.15-.13-.3-.18-.46-.05-.16-.09-.32-.12-.49-.03-.17-.05-.34-.06-.51-.01-.17-.02-.34-.02-.51 0-.17.01-.34.02-.51.01-.17.03-.34.06-.51.03-.17.07-.33.12-.49.05-.16.1-.31.17-.46.07-.15.14-.3.22-.44.08-.14.17-.27.27-.4.1-.13.2-.25.31-.37.11-.12.22-.23.34-.34.12-.11.24-.21.37-.31.13-.1.25-.19.39-.28.13-.09.27-.18.41-.26.14-.08.28-.15.43-.22.15-.07.3-.13.46-.19-.1.12-.2.24-.3.35-.09.11-.19.22-.29.33-.1.1-.2.2-.3.3-.09.1-.19.19-.29.29-.1.09-.2.18-.3.27-.1.09-.2.18-.3.26-.1.09-.2.17-.3.25-.1.08-.2.16-.3.24-.1.08-.2.15-.3.22-.1.07-.2.14-.3.21-.1.07-.2.13-.3.19-.1.06-.2.12-.3.17-.1.05-.2.1-.3.15-.1.04-.2.09-.3.12-.1.04-.2.07-.3.1-.1.03-.2.05-.3.07-.1.02-.2.03-.3.04-.1.01-.2.01-.3.01-.1 0-.2-.01-.3-.02-.1-.01-.2-.03-.3-.05-.1-.02-.2-.05-.3-.08-.1-.03-.2-.07-.3-.11-.1-.04-.2-.09-.3-.14-.1-.05-.2-.11-.3-.18-.1-.06-.2-.14-.3-.21-.1-.08-.2-.16-.3-.25-.1-.09-.2-.18-.3-.28-.1-.1-.2-.2-.3-.31-.1-.11-.19-.22-.29-.34-.09-.12-.18-.24-.27-.36-.09-.13-.17-.25-.25-.39-.08-.13-.15-.27-.22-.41-.07-.14-.13-.29-.19-.44-.06-.15-.11-.3-.15-.47-.04-.16-.07-.33-.09-.5-.02-.17-.03-.35-.03-.52 0-.18.01-.35.04-.52.03-.17.07-.34.12-.5.05-.17.11-.33.18-.48.07-.15.15-.3.24-.44.09-.14.19-.28.3-.4.11-.13.22-.25.35-.37.12-.12.25-.23.39-.33.14-.1.28-.2.43-.29.15-.09.3-.17.46-.24.16-.07.32-.13.49-.18.16-.05.33-.09.5-.12.17-.03.34-.05.52-.06.17-.01.35-.01.52 0 .17.01.35.03.52.07.17.04.34.09.5.15.16.06.32.13.48.22.16.09.31.19.46.3.15.11.29.23.43.36.14.13.27.27.4.42.12.15.24.3.34.47.1.17.2.34.28.52.08.18.15.36.2.55.05.19.09.38.11.58.02.2.02.4.01.59-.02.19-.05.38-.1.56-.05.18-.11.35-.19.52-.08.17-.17.33-.28.48-.1.15-.22.29-.34.43-.12.14-.25.26-.39.38-.14.12-.29.23-.44.33-.15.1-.31.19-.48.27-.17.08-.34.15-.52.2-.18.05-.36.09-.55.11-.19.02-.38.03-.57.02-.18 0-.36-.02-.54-.05-.18-.03-.35-.08-.52-.14-.17-.06-.33-.13-.49-.22-.16-.09-.31-.2-.46-.31-.15-.12-.29-.24-.42-.38-.13-.14-.25-.29-.36-.45-.11-.16-.2-.33-.29-.51-.08-.18-.14-.37-.19-.56-.05-.19-.08-.39-.09-.59-.01-.2-.01-.4.01-.6.02-.2.05-.39.1-.58.05-.19.12-.37.2-.55.08-.18.18-.35.29-.51.11-.16.23-.31.36-.46.13-.14.27-.27.42-.39.15-.12.31-.22.48-.32.17-.09.34-.17.52-.24.18-.07.37-.12.56-.16.19-.04.38-.06.58-.07.2-.01.4 0 .6.03.2.02.39.07.58.14"/>
                        </svg>
                        Notion darsliklari
                    </a>
                    {% endif %}
                </div>
            </div>
            
            <div id="video-{{ forloop.counter }}" class="mt-4" style="display: none;">
                {% if lesson.video_id %}
                    <!-- Video oynasi -->
                    <div style="width: 100%; max-width: 800px; margin: 0 auto;">
                        <div style="position: relative; padding-bottom: 56.25%; height: 0; overflow: hidden;">
                            <iframe 
                                src="https://kinescope.io/embed/{{ lesson.video_id }}" 
                                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; border: none;"
                                frameborder="0" 
                                allow="autoplay; fullscreen; picture-in-picture" 
                                allowfullscreen>
                            </iframe>
                        </div>
                        
                        <!-- Video havolasi -->
                        <div style="text-align: center; margin-top: 10px;">
                            <a href="https://kinescope.io/{{ lesson.video_id }}" 
                               target="_blank" 
                               class="inline-flex items-center px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700 transition-colors">
                                <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 8a2 2 0 012-2h12a2 2 0 012 2v8a2 2 0 01-2 2H6a2 2 0 01-2-2V8z"></path>
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 12l-5-3v6l5-3z"></path>
                                </svg>
                                Videoni to'liq ekranda ko'rish
                            </a>
                        </div>
                    </div>
                    
                    <script>
                        document.getElementById('thumbnail-{{ forloop.counter }}').onclick = function() {
                            document.getElementById('video-{{ forloop.counter }}').style.display = 'block';
                            return false;
                        };
                    </script>
                    
                    </div>
                    <p class="mt-2 text-sm text-gray-500">
                        Video yuklanmasa, 
                        <a href="https://kinescope.io/{{ lesson.video_id }}" target="_blank" class="inline-flex items-center px-3 py-1.5 bg-gray-100 hover:bg-gray-200 text-gray-800 rounded-md text-sm transition-colors ml-1">
                            <svg class="w-3.5 h-3.5 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14"></path>
                            </svg>
                            shu yerni bosing
                        </a>
                    </p>
                {% else %}
                    <div class="bg-yellow-100 border-l-4 border-yellow-500 text-yellow-700 p-4 mb-4">
                        <p>Video yuklanmagan. Iltimos, video ID ni tekshiring.</p>
                        {% if user.is_staff %}
                            <a href="/admin/courses/lesson/{{ lesson.id }}/change/" class="text-blue-600 hover:underline">
                                Video ID ni tahrirlash
                            </a>
                        {% endif %}
                    </div>
                {% endif %}
            </div>
        </div>
        {% endif %}
        
        {% if lesson.description %}
        <p class="mt-4 text-gray-700">{{ lesson.description }}</p>
        {% endif %}
        
        <div class="mt-4 flex justify-end">
            {% if not forloop.first %}
            <button onclick="window.scrollTo({top: 0, behavior: 'smooth'})" class="text-blue-600 hover:underline">Yuqoriga qaytish</button>
            {% endif %}
        </div>
    </div>
    {% empty %}
    <div class="text-center py-10 text-xl text-gray-500">
        Hozircha darslar qo'shilmagan.
    </div>
    {% endfor %}
    {% endif %}
</div>

<script>
function toggleVideo(lessonNumber) {
    const videoContainer = document.getElementById(`video-${lessonNumber}`);
    if (videoContainer.style.display === 'none') {
        videoContainer.style.display = 'block';
        // Scroll to the video
        videoContainer.scrollIntoView({ behavior: 'smooth', block: 'center' });
    } else {
        videoContainer.style.display = 'none';
    }
}

// Auto-show first video if it exists
window.onload = function() {
    const firstVideo = document.querySelector('.video-container');
    if (firstVideo) {
        firstVideo.style.display = 'block';
    }
};
</script>

<style>
.video-container {
    position: relative;
    padding-bottom: 56.25%; /* 16:9 Aspect Ratio */
    height: 0;
    overflow: hidden;
    margin: 1rem 0;
    background: #000;
    border-radius: 8px;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
}
.video-container iframe {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    border: 0;
}
.video-placeholder {
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    display: flex;
    align-items: center;
    justify-content: center;
    background: #f0f0f0;
    color: #666;
    font-size: 1.2em;
}
</style>

{% endblock %}